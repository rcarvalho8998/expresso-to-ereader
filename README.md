# Calibre

Calibre here serves as a database of books (self-managed by calibre and should not be touched), which is is under: "/config/Calibre Library".

Ebooks are added to the /import folder which is shared with readarr's download folder.

There is a web interface in port "8780" (maps to 8080 in container)

# Setup
To start the calibre image you just need to run the command:
```bash
    docker compose up -d
```
Access the <server_address>:8780 to get to the GUI.
To automatically enable calibre to import the books, you need to:
1. Click on "Add Books"'s down arrow

2. Click on "Control the adding of books"

3. Go to "Automatic adding" Tab

4. Specify the "/import" folder

5. Restart the container.

Aftwards all book put in that folder will be added to the Calibre Database.


# Using ebook-convert as a command.
Calibre comes with the ebook-convert library which is typically used to convert ebooks or even web pages to the desired format.

While the container is running we can access the command using docker's exec command.

### Example
Here I'm trying to use the expresso.recipe to download web pages from expresso.pt to epub format.
```bash
    docker exec --user 1000 calibre ebook-convert ./recipes/expresso.recipe /import/expresso.epub  --username <expresso_username> --password <expresso_password>
```
We need to add the `--user 1000` flag in the docker command because this os defined as the user that can control calibre's files as you can see in the docker-compose:
```yaml
  calibre:
    image: lscr.io/linuxserver/calibre
    container_name: calibre
    environment: 
      - PUID=1000
      - PGID=1000
```

The ebook-convert has these commands:

1. ebook-convert

2. <recipe_file_location> (which is inside the container)

3. <output_file_location> (which is inside the container)

4. <output_ebook_format>

5. <recipe_arguments>..

    1. --username <username> (specific to expresso.recipe)

    1. --password <password> (specific to expresso.recipe)


# Using ebook-convert as a cron job
First thing to do is change the .env file to input the user and password to be used to access expresso.pt

### .env
```properties
EXPRESSO_USERNAME=<your_username>
EXPRESSO_PASSWORD=<your_password>
```

Then make sure the cronjob is defined in the cron/calibre-cron file.
```bash
# Add you crontabs here #

23 7 * * 5 /scripts/ebook-download-script.sh >> /var/log/cron.log

# Don't remove the empty line at the end of this file. It is required to run the cron job
```
Here the cron is running a script every Friday at 7:23 AM.

You can add more jobs to this file and they will be run as the user "abc" inside the container.

The script simply calls the ebook-convert with the expresso recipe to download the correct epub.


## Making sure the container can run the job
This container does not initialize the cron service by itself so we need to add the cron-init.sh script before running the already existing /init from the container.

### cron-init.sh
```bash
printenv | grep -v "no_proxy" > /etc/environment # Used to allow crontab to access the environment variables

chmod +x /etc/cron.d/calibre-cron
chmod +x /scripts/ebook-download-script.sh
username=$(getent passwd $PUID | awk -F':' '{ print $1 }') #Get the username from the defined PUID | This does not work as it get the kasm-user the abc user is currently 911, it only becomes $PUID after this script runs.
echo "$username\nabc\nroot\n" > /etc/cron.allow #Adding permissions to the user, abc and root to run.
usermod -a -G crontab $username #Adding the user to the crontab group
usermod -a -G crontab abc #Adding the user to the crontab group
crontab -u $username /etc/cron.d/calibre-cron # Run crontab as the user
```

This script begins to print all env variables to the /etc/environment so we can access the variables in the cron (as the cron does not run in a bash environment).
It can read the variables because in the begining of this:

### ebook-downoad-script.sh

```bash
source $HOME/.bash_profile

#Your script here
```

The rest of the commands will take care of permissions for files and run the crontab command as the defined **$PUID** user.

## Why the permission handling?
This container runs all jobs as a root user, so all the files generated by the cronjob's script will be owned by the root user which calibre does not have pemission to import automatically.

So the script needs to be run by the same user as the one that is handling calibre (defined by the PUID).
